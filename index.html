<!DOCTYPE html>
<html>
<head>
    <title>Date Input Formatter</title>
    <style>
        .date-input {
            padding: 10px;
            font-size: 16px;
            width: 200px;
            margin: 10px;
        }
        .invalid {
            border: 2px solid red;
        }
    </style>
</head>
<body>
    <input type="text" 
           class="date-input" 
           placeholder="DD/MM/YYYY"
           maxlength="10"
           id="dateInput">

    <script>
        const dateInput = document.getElementById('dateInput');
        let lastValidValue = '';

        dateInput.addEventListener('input', function(e) {
            // Store caret position
            const caretPos = e.target.selectionStart;
            
            // Remove all non-numeric characters
            let value = e.target.value.replace(/[^0-9]/g, '');
            
            // Format with separators
            let formatted = '';
            if (value.length > 0) {
                formatted += value.substr(0, 2);
                if (value.length >= 2) {
                    formatted += '/';
                    if (value.length >= 2) {
                        formatted += value.substr(2, 2);
                        if (value.length >= 4) {
                            formatted += '/';
                            formatted += value.substr(4, 4);
                        }
                    }
                }
            }

            // Validate parts
            const day = parseInt(value.substr(0, 2)) || 0;
            const month = parseInt(value.substr(2, 2)) || 0;
            const year = parseInt(value.substr(4, 4)) || 0;

            // Enforce maximum values
            if (day > 31) value = '31' + value.substr(2);
            if (month > 12) value = value.substr(0, 2) + '12' + value.substr(4);
            if (year > 9999) value = value.substr(0, 4) + '9999';

            // Update input value
            if (this.value !== formatted) {
                this.value = formatted;
            }

            // Validate individual parts
            let isValid = true;
            if (value.length >= 2 && (day < 1 || day > 31)) isValid = false;
            if (value.length >= 4 && (month < 1 || month > 12)) isValid = false;
            if (value.length >= 8 && (year < 1900 || year > new Date().getFullYear() + 2)) isValid = false;

            // Apply validation styling
            this.classList.toggle('invalid', !isValid);
            
            // Maintain caret position
            const diff = formatted.length - e.target.value.length;
            this.setSelectionRange(caretPos + diff, caretPos + diff);
        });

        // Prevent non-numeric input
        dateInput.addEventListener('keydown', function(e) {
            if (e.key.length === 1 && !/\d/.test(e.key) && !e.ctrlKey) {
                e.preventDefault();
            }
        });
    </script>
</body>
</html>
